name: Build Release

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      release:
        description: "Create a release (will create and push a version tag)"
        required: false
        default: false
        type: boolean

jobs:
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.gitversion.outputs.semVer }}
      safe_version: ${{ steps.check.outputs.SAFE_VERSION }}
      major_minor_patch: ${{ steps.gitversion.outputs.majorMinorPatch }}
      is_release: ${{ steps.check.outputs.IS_RELEASE }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v4.2.0
        with:
          versionSpec: '6.x'

      - name: Determine version
        id: gitversion
        uses: gittools/actions/gitversion/execute@v4.2.0
        with:
          useConfigFile: true

      - name: Check if release and sanitize version
        id: check
        run: |
          # Sanitize version for GitHub tags (replace + with -)
          SEMVER="${{ steps.gitversion.outputs.semVer }}"
          SAFE_VERSION="${SEMVER//+/-}"
          echo "SAFE_VERSION=${SAFE_VERSION}" >> $GITHUB_OUTPUT

          if [[ "${{ github.ref }}" == refs/tags/v* ]] || [[ "${{ github.event.inputs.release }}" == "true" ]]; then
            echo "IS_RELEASE=true" >> $GITHUB_OUTPUT
          else
            echo "IS_RELEASE=false" >> $GITHUB_OUTPUT
          fi
          echo "Version: ${SEMVER}"
          echo "Safe Version: ${SAFE_VERSION}"

      - name: Create and push release tag
        if: github.event.inputs.release == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ steps.gitversion.outputs.majorMinorPatch }}" -m "Release v${{ steps.gitversion.outputs.majorMinorPatch }}"
          git push origin "v${{ steps.gitversion.outputs.majorMinorPatch }}"

  build:
    name: Build (${{ matrix.goos }}/${{ matrix.goarch }})
    runs-on: ${{ matrix.os }}
    needs: prepare
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            os: ubuntu-latest
          - goos: linux
            goarch: arm64
            os: ubuntu-24.04-arm
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: stable
          cache: true

      - name: Run tests
        run: go test ./...

      - name: Build histui
        env:
          CGO_ENABLED: 0
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          go build -ldflags "-s -w -X main.version=${{ needs.prepare.outputs.version }} -X main.commit=${{ github.sha }} -X main.buildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ)" -o histui ./cmd/histui

      - name: Create archive
        run: |
          mkdir -p dist
          tar -czvf dist/histui_${{ needs.prepare.outputs.safe_version }}_${{ matrix.goos }}_${{ matrix.goarch }}.tar.gz \
            histui \
            LICENSE \
            README.md

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: histui_${{ needs.prepare.outputs.safe_version }}_${{ matrix.goos }}_${{ matrix.goarch }}
          path: dist/*.tar.gz
          retention-days: 1

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [prepare, build]
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts
          merge-multiple: false

      - name: Prepare release assets
        run: |
          mkdir -p release
          find artifacts -name "*.tar.gz" -exec mv {} release/ \;
          echo "=== Release assets ==="
          ls -la release/

      - name: Generate checksums
        run: |
          cd release
          sha256sum *.tar.gz > histui_${{ needs.prepare.outputs.safe_version }}_checksums.txt
          echo "=== Checksums ==="
          cat histui_${{ needs.prepare.outputs.safe_version }}_checksums.txt

      - name: Generate changelog
        run: |
          if [[ "${{ needs.prepare.outputs.is_release }}" != "true" ]]; then
            echo "Development build from commit ${{ github.sha }}" > changelog.txt
            echo "" >> changelog.txt
            echo "Version: ${{ needs.prepare.outputs.version }}" >> changelog.txt
            echo "" >> changelog.txt
            echo "Commit: $(git log -1 --pretty=%B)" >> changelog.txt
          else
            PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
            if [ -n "$PREV_TAG" ]; then
              echo "## Changelog" > changelog.txt
              echo "" >> changelog.txt
              git log --pretty=format:"* %h %s" $PREV_TAG..HEAD | \
                grep -v "^* [a-f0-9]* docs:" | \
                grep -v "^* [a-f0-9]* test:" | \
                grep -v "^* [a-f0-9]* ci:" | \
                grep -v "^* [a-f0-9]* Merge" >> changelog.txt || echo "* No notable changes" >> changelog.txt
            else
              echo "* Initial release" > changelog.txt
            fi
          fi
          echo "=== Changelog ==="
          cat changelog.txt

      - name: Clean up old pre-releases
        if: needs.prepare.outputs.is_release != 'true'
        run: |
          echo "Cleaning up old pre-releases (keeping 5 most recent)..."
          PRERELEASES=$(gh release list --limit 100 --json tagName,isPrerelease,createdAt \
            --jq '[.[] | select(.isPrerelease == true)] | sort_by(.createdAt) | .[].tagName')

          TOTAL=$(echo "$PRERELEASES" | grep -c . || echo 0)
          echo "Found $TOTAL pre-releases"

          TO_DELETE=$((TOTAL - 4))
          if [ "$TO_DELETE" -gt 0 ]; then
            echo "Deleting $TO_DELETE old pre-releases..."
            echo "$PRERELEASES" | head -n "$TO_DELETE" | while read -r tag; do
              if [ -n "$tag" ]; then
                echo "Deleting release: $tag"
                gh release delete "$tag" --yes --cleanup-tag || true
              fi
            done
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ needs.prepare.outputs.is_release == 'true' && format('v{0}', needs.prepare.outputs.safe_version) || format('v{0} (pre-release)', needs.prepare.outputs.safe_version) }}
          tag_name: v${{ needs.prepare.outputs.safe_version }}
          body_path: changelog.txt
          files: release/*
          draft: false
          prerelease: ${{ needs.prepare.outputs.is_release != 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
